# Hypercommit Infrastructure

Docker-based deployment setup for Hypercommit with PostgreSQL, Git HTTP backend, and Caddy reverse proxy.

## Prerequisites

- Docker and Docker Compose installed on your VPS
- Domain DNS configured:
  - `hypercommit.com` → Your VPS IP
  - `www.hypercommit.com` → Your VPS IP
- `openssl` for generating secure secrets (usually pre-installed)

## Quick Start

1. **Clone the repository** on your VPS:

   ```bash
   git clone <your-repo-url>
   cd hypercommit/infra
   ```

2. **Initialize environment** (generates secure passwords and secrets):

   ```bash
   chmod +x init.sh
   ./init.sh
   ```

   The script will:
   - Generate secure PostgreSQL password
   - Generate Better Auth secret
   - Prompt for your domain
   - Create `.env` file with all configuration

3. **Deploy**:

   ```bash
   chmod +x start.sh
   ./start.sh
   ```

   The script will:
   - Build and start all services
   - Wait for PostgreSQL to be ready
   - Run database migrations automatically
   - Verify deployment success

## What's Included

- **PostgreSQL**: Database for users, repositories, auth (internal port 5432)
- **Hypercommit**: Next.js app with Git HTTP backend (internal port 3000)
  - Git HTTP endpoints for clone/push/pull operations
  - User authentication via better-auth
  - Repository management
  - Persistent git repository storage
- **Caddy**: Automatic HTTPS with Let's Encrypt, reverse proxy (ports 80, 443)
- **Watchtower**: Automatic container updates (checks every 10 seconds)
- **Domain redirect**: `hypercommit.com` → `www.hypercommit.com`

## Architecture

```
┌─────────────────────────────────────────────────┐
│              Internet (HTTPS/HTTP)              │
└────────────────────┬────────────────────────────┘
                     │
              ┌──────▼──────┐
              │    Caddy    │  :80, :443
              │  (Reverse   │  Auto SSL
              │   Proxy)    │
              └──────┬──────┘
                     │
           ┌─────────▼──────────┐
           │    Hypercommit     │  :3000
           │   (Next.js + Git)  │
           │  ┌──────────────┐  │
           │  │ Git Repos    │  │  /data/repositories
           │  │  Storage     │  │  (persistent volume)
           │  └──────────────┘  │
           └────────┬───────────┘
                    │
              ┌─────▼──────┐
              │ PostgreSQL │  :5432
              │            │  (internal)
              └────────────┘
```

## Files

- `docker-compose.yml` - Service definitions (PostgreSQL, app, Caddy, Watchtower)
- `Dockerfile` - Next.js app container with Git and Bun
- `Caddyfile` - Caddy configuration with HTTPS
- `init.sh` - Initialization script (generates secrets)
- `start.sh` - Deployment script (builds, migrates, starts)
- `.env.example` - Environment template

## Environment Variables

The `.env` file is automatically generated by `init.sh` and contains:

```bash
# PostgreSQL
POSTGRES_PASSWORD=<auto-generated>
DATABASE_URL=postgresql://hypercommit:<password>@postgres:5432/hypercommit

# Better Auth
BETTER_AUTH_SECRET=<auto-generated>
BETTER_AUTH_URL=https://www.hypercommit.com

# Application
NEXT_PUBLIC_BETTER_AUTH_URL=https://www.hypercommit.com
NEXT_PUBLIC_APP_URL=https://www.hypercommit.com

# Git Storage
GIT_REPOS_PATH=/data/repositories

# Optional: Watchtower notifications
WATCHTOWER_NOTIFICATION_URL=
```

## Manual Commands

```bash
# Start services
docker compose up -d

# Stop services
docker compose down

# View logs
docker compose logs -f hypercommit      # App logs
docker compose logs -f postgres         # Database logs
docker compose logs -f caddy            # Reverse proxy logs

# Rebuild after code changes
docker compose down
docker compose build --no-cache
docker compose up -d

# Run migrations manually
docker compose exec hypercommit bun run db:push

# Access PostgreSQL shell
docker compose exec postgres psql -U hypercommit -d hypercommit

# Check service status
docker compose ps

# View git repositories
docker compose exec hypercommit ls -la /data/repositories
```

## Data Persistence

All data is stored in Docker volumes:

- `postgres-data` - PostgreSQL database
- `git-repos` - Git repositories (bare repos)
- `caddy-data` - SSL certificates
- `caddy-config` - Caddy configuration

Backup these volumes to prevent data loss:

```bash
# Backup PostgreSQL
docker compose exec postgres pg_dump -U hypercommit hypercommit > backup.sql

# Backup git repositories
docker run --rm -v hypercommit_git-repos:/data -v $(pwd):/backup alpine tar czf /backup/git-repos-backup.tar.gz /data
```

## SSL Certificates

Caddy automatically obtains and renews SSL certificates from Let's Encrypt. Certificates are stored in the `caddy-data` volume.

## Git HTTP Operations

Users can clone/push/pull repositories via HTTPS:

```bash
# Clone a repository
git clone https://www.hypercommit.com/git/username/repo-name

# Push to a repository (requires authentication)
git push origin main

# Authentication uses HTTP Basic Auth with your app credentials
```

## Updating

```bash
cd hypercommit/infra
./start.sh
```

The script will:
1. Pull latest code from git
2. Rebuild containers
3. Run migrations
4. Restart services

## Troubleshooting

**Services not starting:**

```bash
docker compose logs
```

**Database connection issues:**

```bash
# Check PostgreSQL is healthy
docker compose ps postgres

# Check database logs
docker compose logs postgres

# Verify connection string in .env
cat .env | grep DATABASE_URL
```

**Git operations failing:**

```bash
# Check git binary in container
docker compose exec hypercommit which git

# Check repository permissions
docker compose exec hypercommit ls -la /data/repositories

# Check application logs for auth errors
docker compose logs hypercommit | grep -i git
```

**Certificate issues:**

- Ensure DNS is properly configured and propagated
- Check Caddy logs: `docker compose logs caddy`
- Verify domain in Caddyfile matches your DNS

**Port conflicts:**

- Ensure ports 80 and 443 are available
- Check with: `sudo netstat -tulpn | grep -E ':(80|443)'`

**Migration failures:**

```bash
# Check database connection
docker compose exec hypercommit sh -c "cd /app && bun run db:push"

# View migration files
docker compose exec hypercommit ls -la /app/drizzle
```
